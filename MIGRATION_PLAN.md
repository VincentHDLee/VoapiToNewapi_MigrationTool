# VoAPI 至 NewAPI 用户数据迁移计划 (MIGRATION_PLAN.md)

**文档版本:** 1.0
**创建日期:** 2025年06月19日
**当前状态:** Phase 3 (数据迁移脚本) 开发中

## 1. 项目背景与目标

### 1.1. 项目简报

* **当前系统 (Source):** `voapi`。一个基于 `NewAPI` & `OneAPI` 进行二次开发的AI接口管理与分发系统，目前正在生产环境中运行。
* **目标系统 (Target):** `newapi`。`voapi` 的上游开源项目，我们将把用户数据迁移至此系统的一个全新实例。
* **核心挑战:** `voapi` 因其二次开发，数据库表结构已与 `newapi` **不兼容**。因此，无法直接通过替换数据库文件或导入SQL备份的方式进行迁移。必须采用编写自定义脚本的方案。

### 1.2. 核心目标

安全、准确地将 `voapi` 实例的核心用户数据（包括用户账户、账户额度、API令牌等）迁移至一个全新的 `newapi` 实例中。最终目标是在本地完成所有测试，并制定出可在生产环境执行的最终方案。

## 2. 现有资产与准备工作

### 2.1. VoAPI 项目完整备份

我们已从生产服务器 `/opt/voapi-service` 成功打包并下载了项目完整备份。该备份包含了运行一个完整克隆实例所需的所有数据。

#### 关键内容清单：
* **核心数据源:**
    * **路径:** `./backups/mariadb_voapi_mysql_20250618-154648.sql.gz`
    * **说明:** 这是本次迁移最主要的数据来源，包含了所有用户数据的快照。
* **配置文件:**
    * `docker-compose.yml`: 服务编排文件。
    * `.env`: 环境变量文件。
    * `nginx/nginx.conf`: Web服务器反向代理配置。
* **SSL证书:**
    * `certs/` 目录下的 `.pem` 文件。
* **静态资源:**
    * `static/images/` 目录下的网站Logo等图片。
* **实时数据库文件 (备用参考):**
    * `mysql_data/` 目录。在分析表结构时，可作为实时数据库的参考。

### 2.2. NewAPI 项目源码
已在本地电脑克隆了最新的 `newapi` 项目仓库。

### 2.3. 开发环境
所有迁移脚本的开发和测试工作，均在本地电脑上进行，以确保生产环境的绝对安全。

## 3. 迁移执行计划 (任务列表)

### Phase 1: 本地环境搭建
* [x] **任务 1.1: 搭建VoAPI本地实例**
    * **状态:** 已完成。`voapi-service` 在 Docker 中成功运行，并导入了数据备份。

* [x] **任务 1.2: 搭建NewAPI“基准”实例**
    * **状态:** 已完成。`new-api` 在 Docker 中成功运行，并挂载了基准数据。

### Phase 2: 数据分析与映射
* [x] **任务 2.1: 对比数据库核心表结构**
    * **状态:** 已完成。Schema DDL 文件已导出。

* [x] **任务 2.2: 创建字段映射文档**
    * **状态:** 已完成。详见 **[`FIELD_MAPPING.md`](FIELD_MAPPING.md:1)**。

### Phase 3: 迁移脚本开发
* [x] **任务 3.1: 编写数据读取/导出脚本**
    * **状态:** 已完成。已创建 **[`migration_scripts/01_export_voapi_data.py`](migration_scripts/01_export_voapi_data.py:1)** 并成功导出数据为 CSV 文件。

* [x] **任务 3.2 & 3.3: 开发数据转换与导入脚本**
    * **状态:** 已完成。已创建 **[`migration_scripts/02_transform_and_import_data.py`](migration_scripts/02_transform_and_import_data.py:1)**，脚本已根据最终的“清空并覆盖”策略调整完毕。
    * **目的:** 将转换后的数据安全地写入本地的 `newapi` 数据库。
    * **建议:** 使用数据库事务 (Transaction) 确保数据写入的原子性，避免部分成功部分失败的情况。

### Phase 4: 本地测试与验证
* [x] **任务 4.1: 执行完整本地迁移脚本**
    * **状态:** 已完成。在本地环境中完整运行了一次迁移流程。

* [x] **任务 4.2: 数据一致性校验**
    * **状态:** 已完成。通过多次执行和日志验证，确认了 `users`, `tokens`, `logs`, `channels`, `abilities`, `options`, `redemptions` 等核心数据的迁移准确性。

* [x] **任务 4.3: 核心功能回归测试**
    * **状态:** 已完成。通过登录测试和密码自动重置功能验证，确认迁移后的核心功能可用。

## 4. 备忘录与关键注意事项

1.  **密码处理:** 用户密码因加密方式不同，**无法直接迁移**。最终方案必须包含“通知所有用户通过‘忘记密码’功能重置密码”的流程。
2.  **功能性数据丢失:** `voapi` 特有的功能数据（如签到记录、IP登录日志、风控日志等）将被**舍弃**，因为 `newapi` 没有对应的功能来承载这些数据。这是符合预期的。
3.  **脚本健壮性:** 迁移脚本应包含充分的日志记录和错误处理机制，方便在出错时快速定位问题。
4.  **最终交付物:** 本次本地迁移计划的最终交付物是一个**经过验证的、可重复执行的迁移脚本**，以及一份更新版的、用于生产环境的迁移执行手册。

## 5. 战略调整与新的迁移原则 (2025-06-19)

经讨论，项目战略做出重大调整。我们不再将数据迁移到一个空的`newapi`实例，而是迁移到一个**已包含最新渠道和价格配置的“基准”数据库**中。

这一调整将迁移任务从“技术验证”提升为更贴近真实业务需求的“数据融合”实践。

### 5.1. 新的迁移哲学：引用与融合

迁移脚本的核心思想从“导出-导入”转变为“**引用与融合**”。

1.  **数据源分离:**
    *   **用户类数据源 (源):** `voapi` 数据库 (`users`, `tokens`, `logs` 等)。
    *   **配置类数据源 (基准):** `newapi` 的测试实例数据库 (`channels`, `pricings`, `groups` 等)。

2.  **用户数据为“纯插入”:**
    *   脚本在处理 `voapi` 的用户数据时，默认为**新增数据**并直接插入 `newapi` 数据库。

3.  **配置数据为“只读和引用”:**
    *   脚本**绝不能**修改或删除 `newapi` 基准数据库中的任何配置数据。
    *   当迁移需要关联配置的数据时（如日志），脚本需要根据 `voapi` 的信息（如模型名称），去 `newapi` 的 `channels` 或 `pricings` 表中**查询并获取**对应的ID，然后用这个ID作为外键插入新记录。

### 5.2. 冲突解决策略

*   **默认策略:** 当遇到数据冲突时（如用户名或邮箱已存在），**跳过 `voapi` 中的重复用户，并生成详细的日志记录**，以便后续人工审查。这是在**开发与测试阶段**最安全、最稳妥的方式。

### 5.3. 最终生产迁移策略 (2025-06-19)

**核心决策:** 最终的生产环境迁移将面向一个**完全空的 `newapi` 数据库实例**。

因此，迁移脚本的最终形态将采用 **“清空并覆盖” (Truncate and Load)** 的策略：
1.  **清空目标表:** 在导入数据前，使用 `TRUNCATE` 命令清空所有目标表。
2.  **全量导入:** 将从 `voapi` 导出的全部数据进行转换后，完整地导入到空的 `newapi` 表中。

此策略取代了开发阶段的“引用与融合”和“跳过冲突”策略，以确保生产环境的干净和数据一致性。

## 6. 开发环境迁移 (2025-06-19)

在本地 Windows 环境恢复 MySQL 数据时，遇到了由文件系统大小写不敏感导致的 `lower_case_table_names` 配置冲突问题。该问题阻碍了本地数据库环境的搭建。

**决策：**
为了从根源上解决此环境兼容性问题，并确保开发环境与服务器生产环境（Linux）的高度一致性，**项目组决定将整个迁移工作区（包括代码、数据库实例等）全部转移到一台 Ubuntu 开发服务器上进行。**

**影响与优势:**
1.  **消除环境障碍:** 彻底解决 `lower_case_table_names` 冲突。
2.  **简化流程:** 无需再对数据进行“转储再导入”的清洗操作，可直接使用备份的数据文件。
3.  **提高效率:** 避免在解决特定于操作系统的环境问题上耗费时间，使团队能专注于核心的迁移脚本开发工作。

**状态：准备工作已完成。所有后续操作将在新的 Ubuntu 开发服务器上执行。**